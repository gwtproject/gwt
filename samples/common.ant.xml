<project name="samples-common">
  <property name="gwt.root" location="../.." />
  <property name="project.tail" value="samples/${sample.root}" />
  <import file="${gwt.root}/common.ant.xml" />

  <!--
    Number of localworkers for sample compilation.  This depends on your
    hardware, so it's a good candidate to specify in local.ant.properties
    if this default isn't good for you.  Ideally, it should approximate
    the number of CPU cores in your machine.
  -->
  <property name="gwt.samples.localworkers" value="2" />

  <property name="sample.lower" value="${sample.root}" />
  <property name="sample.upper" value="${sample.module}" />

  <property name="gwt.args" value="" />

  <property.ensure name="gwt.user.jar" location="${gwt.build.lib}/gwt-user.jar" />
  <property.ensure name="gwt.dev.jar" location="${gwt.build.lib}/gwt-dev.jar" />
  <property.ensure name="gwt.codeserver.jar" location="${gwt.build.lib}/gwt-codeserver.jar" />

  <!-- Mirror directory for scripts; makes building distro easier -->
  <property name="samples.scripts" value="${gwt.build.out}/samples-scripts" />
  <!-- Use the uppercase name rather than the lowercase name -->
  <property name="sample.build" value="${gwt.build.out}/samples/${sample.upper}" />

  <!-- The libraries required by the server that will be copied into WEB-INF/lib. -->
  <fileset id="sample.server.libs" dir="${gwt.tools.lib}">
    <include name="" />
  </fileset>

  <target name="source" depends="check.build.type" description="Copy source to the output folder">
    <mkdir dir="${sample.build}/src" />
    <copy todir="${sample.build}/src">
      <fileset dir="src" />
    </copy>
    <if>
      <available file="pom.xml"/>
      <then>
        <copy tofile="${sample.build}/pom.xml" file="pom.xml"/>
      </then>
    </if>
    <if>
      <available file="README.txt"/>
      <then>
        <copy tofile="${sample.build}/README.txt" file="README.txt"/>
      </then>
    </if>
  </target>

  <target name="compile" description="Compile all java files">
    <gwt.mvn dir="${sample.build}" args="compile" />
  </target>

  <target name="build" depends="source, compile, gwtc, scripts" description="Build and package this project" />

  <target name="clean" description="Cleans this project's intermediate and output files">
    <delete dir="${sample.build}" />
    <delete includeemptydirs="true">
      <fileset dir="${samples.scripts}">
        <include name="*/${sample.upper}/**" />
      </fileset>
    </delete>
  </target>

  <target name="devmode" depends="source, compile"
    description="Run Super Dev Mode (pass -Dgwt.args=-nosuperDevMode to fallback to classic DevMode)">
    <property name="sample.package" value="com.google.gwt.sample.${sample.root}" />
    <java failonerror="true" fork="true" classname="com.google.gwt.dev.DevMode">
      <classpath>
        <pathelement location="${sample.path}"/>
        <pathelement location="${gwt.user.jar}"/>
        <pathelement location="${gwt.dev.jar}"/>
        <pathelement location="${gwt.codeserver.jar}"/>
        <pathelement location="${sample.build}/war/WEB-INF/classes" />
        <path refid="sample.extraclasspath" />
      </classpath>
      <arg line="${gwt.args}"/>
      <arg line="-war"/>
      <arg value="${sample.build}/war"/>
      <arg value="${sample.package}.${sample.module}"/>
    </java>
  </target>
</project>
